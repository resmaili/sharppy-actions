name: Run Build
defaults:
  run:
    shell: bash -l {0}

# inputs:
#   python-version:
#     required: true
  # repo-token:
  #   required: true

runs:
  using: composite
  steps:

    # Run pytest and publish results -----------------------
    - name: Run Pytest
      shell: bash -l {0}
      run: |
        conda activate devel
        pip install -e .
        pytest -v --junitxml=test-results.xml --color=yes

    - name: Publish Pytest Results for Windows
      uses: EnricoMi/publish-unit-test-result-action/composite@v1
      with:
        files: "test-results.xml"

    - name: Publish Test Results for Mac/Linux
      uses: EnricoMi/publish-unit-test-result-action@v1
      if: startsWith(runner.os, 'lin') || startsWith(runner.os, 'mac')
      with:
        files: "test-results.xml"

    # Build Windows/Mac binaries -----------------------
    - name: Build for ${{runner.os}}
      shell: bash -l {0}
      run: |
        cd runsharp
        OS=${{runner.os}}
        echo ${OS:0:3}
        if [[ "${OS:0:3}" == "mac" ]]; then
          pyinstaller SHARPpy-mac-64.spec --log-level DEBUG
        elif [[ "${OS:0:3}" == "Win" ]]; then
          pyinstaller SHARPpy-win7-64.spec --log-level DEBUG
        fi
        cd ..

    # Tag and release if pushed to main -----------------------
    # - name: Bump version and push tag
    #   id: tag_version
    #   uses: mathieudutour/github-tag-action@v6.0
    #   with:
    #     github_token: ${{ inputs.repo-token }}
    #     default_bump: 'minor'
    #
    # - name: Create ${{ runner.os }} release
    #   uses: ncipollo/release-action@v1
    #   with:
    #     artifacts: "SHARPpy-${{ runner.os }}.zip"
    #     allowUpdates: true
    #     tag: ${{ steps.tag_version.outputs.new_tag }}
    #     name: Release ${{ steps.tag_version.outputs.new_tag }}
    #     body: ${{ steps.tag_version.outputs.changelog }}

    # Unused -----------------------
      # commit: 'master'
      # token: ${{ secrets.GITHUB_TOKEN }}


      # Publish those artifacts for this build so testers can view them.
      # - uses: actions/upload-artifact@v3
      #   with:
      #     name: screenshots
      #     path: examples/data/
