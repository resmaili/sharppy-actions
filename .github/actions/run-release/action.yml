name: Run Release
defaults:
  run:
    shell: bash -l {0}

inputs:
  repo-token:
    required: true

runs:
  using: composite
  steps:
    # Archive the binaries -----------------------
    - name: Archive release on Windows
      uses: thedoctor0/zip-release@main
      if: startsWith(runner.os, 'win')
      with:
        type: 'zip'
        filename: 'SHARPpy-${{runner.os}}.zip'
        path: runsharp/dist/SHARPpy.exe

    - name: Archive release on Mac
      uses: thedoctor0/zip-release@main
      if: startsWith(runner.os, 'mac')
      with:
        type: 'zip'
        filename: 'SHARPpy-${{runner.os}}.zip'
        path: runsharp/dist/SHARPpy.app

    # Tag and release if pushed to main -----------------------
    - name: Bump version and push tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.0
      with:
        github_token: ${{ inputs.repo-token }}
        default_bump: 'minor'

    - name: Create ${{ runner.os }} release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "SHARPpy-${{ runner.os }}.zip"
        allowUpdates: true
        tag: ${{ steps.tag_version.outputs.new_tag }}
        name: Release ${{ steps.tag_version.outputs.new_tag }}
        body: ${{ steps.tag_version.outputs.changelog }}
